<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<title>Affirm Checkout</title>
	<script>
	    // Begin Affirm JS embed code
		// =======================
		_affirm_config = {
		    script:"https://cdn1-sandbox.affirm.com/js/v2/affirm.js",
		    public_api_key:"ARQBLCL7NAMBTZ7F"
		};
		(function(l,g,m,e,a,f,b){var d,c=l[m]||{},h=document.createElement(f),n=document.getElementsByTagName(f)[0],k=function(a,b,c){return function(){a[b]._.push([c,arguments])}};c[e]=k(c,e,"set");d=c[e];c[a]={};c[a]._=[];d._=[];c[a][b]=k(c,a,b);a=0;for(b="set add save post open empty reset on off trigger ready setProduct".split(" ");a<b.length;a++)d[b[a]]=k(c,e,b[a]);a=0;for(b=["get","token","url","items"];a<b.length;a++)d[b[a]]=function(){};h.async=!0;h.src=g[f];n.parentNode.insertBefore(h,n);delete g[f];d(g);l[m]=c})(window,_affirm_config,"affirm","checkout","ui","script","ready");
		// =======================
		// End Affirm JS embed code
	</script>
	<style>
		#checkout_button, #first_button {
			height:50px;
			width:400px;
			text-align:center;
			background:#ff0000;
			color:#fff;
			font-weight:900;
			cursor:pointer;
			line-height:50px;
			font-family: helvetica;
		}
		#first_button {
			background: #00ff00;
		}
	</style>
</head>
<body>
<div id="first_button">First</div>
<div id="checkout_button">Checkout</div>
<script>
// Checkout
// -----------------------
// Checkout button
var checkout_button = document.getElementById('checkout_button');
var first_button = document.getElementById('first_button');
checkout_button.addEventListener('click',function(){initiateCheckout()});
first_button.addEventListener('click',function(){
	breakIt();
	watchIt();
});

document.body.onkeypress=function(e){
	if(e.keyCode==13){
	}
};

var currentLocation = location.href;

	function breakIt() {
		console.log('break it!');
		var _a = {
			"page": "https://httpbin.org/post",
			"method": "POST"
		}
		ajaxRequest(_a);

	}
	function ajaxRequest(a) {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
			if (xhttp.readyState === 4) {
				console.log(Date.now() + ": " + a.method + " request returned a " + xhttp.status + " response.");
			    var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?1234';
			    window.history.pushState({path:newurl},'',newurl);
			}
			else {
				console.log(Date.now() + ": " + a.method + " request " + "processing...");
			}
		};
		xhttp.open(a.method, a.page, false);
		console.log(Date.now() + ": " + a.method + " request initiated");
		xhttp.send();
	}
function initiateCheckout () {
	checkout_object = {
		"merchant": {
			"name": "Affirm Example Code",
			"user_cancel_url": currentLocation,
			"user_confirmation_url": currentLocation,
			// User is sent to this URL if they voluntarily cancel/close checkout, or are denied
		},
		"metadata":{
			"mode":"modal"
		},
		"shipping": {
			"name": {
				"first":"Joe",
				"last": "Doe"
			},
			"address": {
				"line1": "633 Folsom St.",
				"line2": "Floor 7",
				"city": "San Francisco",
				"state": "CA",
				"zipcode": "94107"
			},
			"phone_number": "4153334452",
			"email": "joe.doe@123fakestreet.com"
		},
		"billing": {
			"name": {
				"first":"Joe",
				"last": "Doe"
			},
			"address": {
				"line1": "633 Folsom St.",
				"line2": "Floor 7",
				"city": "San Francisco",
				"state": "CA",
				"zipcode": "94107"
			},
			"phone_number": "4153334452",
			"email": "joe.doe@123fakestreet.com"
		},
		"items": [
			{
				"display_name":"Name of item",
				"sku":"123",
				"unit_price":19999,
				"qty": 1,
				"item_image_url":"http://www.google.com",
				"item_url":"http://www.google.com"
			}
		],
		"shipping_amount":499,
		"tax_amount": 30000,
		"total": 30000,
	};
	affirm.checkout(checkout_object);
	affirm.checkout.open(
		{
		onSuccess:function(a){console.log(a)},
		onFail:function(a){console.log(a)}
		}
	);
}
	function watchIt() {
		console.log(Date.now() + ': Watcher has started...');
		var watcher = setInterval(watchingIt, 10);
		function watchingIt() {
			var _a = /1234/.test(document.location.search);
			if (_a) {
				console.log(Date.now() + ': Watcher is initiating checkout!');
				initiateCheckout();
				var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '';
			    window.history.pushState({path:newurl},'',newurl);
				clearInterval(watcher);
				return
			}
			else {
				console.log(Date.now() + ': Watcher is waiting...');
			}
		}
	}
</script>

</body>
</html>