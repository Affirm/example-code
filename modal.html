<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Modal Window Example</title>
</head>
<style>
    html {
        font-family: sans-serif;
        text-align: center;
    }
    input {
        display: block;
    }
    #affirm_checkout_modal {
        position: fixed;
        top:10%;
        left:10%;
        width:600px;
        height:400px;
        border:1px solid #aaa;
        background: red;
    }
    #error {
        display:fixed;
        top:100px;
        margin:0 auto;
        width:400px;
        box-shadow: 0px 3px 5px 1px rgba(0,0,0,.2);
        padding:2em;
        text-align: center;
    }
    #error h4 {

    }
    #sub {

    }
    #sub_extra {
        color:#666;
        font-size:.9em;
    }
    #error_close {
        display: inline-block;
        cursor: pointer;
        border-radius: 5px;
        padding:.2em .4em;
        border:1px solid #aaa;
    }
    .btn {
        cursor: pointer;
        padding: .5em 1em;
        border-radius:5px;
        border:1px solid #aaa;
        text-align: center;
        display: inline-block;
    }
    #affirm_ala .affirm_learn_more {
        text-decoration: underline;
        cursor: pointer;
    }
    
    #container {
        margin: 0 auto;
        width:600px;
        border-radius:5px;
        box-shadow: 0px 5px 10px 1px rgba(0,0,0,.2);
        padding:2em;
    }
</style>
<script>

function grabField(a) {
    var _a = document.getElementById(a);
    if (_a) {if (_a.value) {return _a.value}else {return _a.innerHTML}}
    else {return ""}
}

function setField(_id,_value) {
    var _field = document.getElementById(_id);
    if (_field) {
        if(_value){
            _field.value = _value
        }
        else{
            _field.value = ""
        }
    }
    else {return}
}

var qs = function () {
    var _a = location.search&&location.search.substr(1).replace(/\+/gi," ").split("&");
    var _b = {};
    for (var i in _a) {
        var s = _a[i].split("=");_b[decodeURIComponent(s[0])] = decodeURIComponent(s[1]);
    }
    return _b
};

function updateQs() {
    var _fields = document.getElementById('form').getElementsByTagName('input');
    var _str;
    for (var i = _fields.length - 1; i >= 0; i--) {
        _val = grabField(_fields[i].id);
        if (!_val) {
            return
        }
        _str += "&" + _fields[i].id + "=" + _val;
    }
    var _qs = encodeURI(_str);
    if (history.pushState) {
        var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + "?" + _qs;
        window.history.pushState({path:newurl},'',newurl);
    }
}

function parseQs() {
    var _qs = qs();
    var _keys = Object.keys(_qs);
    for (var i = _keys.length - 1; i >= 0; i--) {
        setField(_keys[i],_qs[_keys[i]]);
    }
}

function initiateCheckout() {

    updateQs();

    var checkout_object = {
        "merchant": {
            // "name": "Affirm Example Code",
            "public_api_key": "PreSeededApiKeyDirect",
            // "public_api_key":"PreSeededApiKeyDirect",
            "user_cancel_url": "http://affirm-demo.com/cherry/affirm_confirmation.php?result=cancel",
            "user_confirmation_url": "http://affirm-demo.com/cherry/affirm_confirmation.php?result=confirm"
            // User is sent to this URL if they voluntarily cancel/close checkout, or are denied
        },
        "order_id":"testest",
        "shipping": {
            "name": {
                "first":"Joe",
                "last": "Doe"
            },
            "address": {
                "line1": "650 California",
                "line2": "",
                "city": "Novato",
                "state": "CA",
                "zipcode": "94947"
            },
            "phone_number": "9253236612",
            "email": "benmoo@gmail.com"
        },
        "billing": {
            "name": {
                "first":"Benjamin",
                "last": "Mo"
            },
            "address": {
                "line1": "2553 Center Road",
                "line2": "",
                "city": "Novato",
                "state": "CA",
                "zipcode": "94947"
            },
            "phone_number": "9253236612",
            "email": "benmoo@gmail.com"
        },
        "items": [
            {
                "display_name":"Name of item",
                "sku":"123",
                "unit_price":19999,
                "qty": 1,
                "item_image_url":"http://www.google.com",
                "item_url":"http://www.google.com"
            }
        ],
        "discounts":{
            "Test with spaces": {
                "discount_display_name": "friendly name",
                "discount_amount": 10000
            }
        },
        "shipping_amount":499,
        "taxAmount": 1000,
        "total": 10000,
        // "checkout_expiration": expire_time()
    };

    var checkout_string = encodeURIComponent(JSON.stringify(checkout_object));

    var options = {
        action: "checkout",
        page: "affirm.php",
        params: "action=checkout&checkout_object=" + checkout_string
    }
    ajaxRequest(options);
}

var newModal = function (_url) {
var _modal = document.createElement("div");
_modal.id = "affirm_checkout_modal";
var _iframe = document.createElement("iframe");
_iframe.width = "600";
_iframe.height = "600";
_iframe.src = _url;
// _iframe.src = "http://localhost/Code/example-code/modal-child.html";
_modal.appendChild(_iframe);
return _modal
}

var safari = function() {
    var ua = window.navigator.userAgent;
    var a = ua.indexOf('safari');
    var b = ua.indexOf('Trident/');
    if (a > 0 || b > 0) {return true}
    else {return false}
}

function launchPromo(event) {
    console.log(event);
    var _url = "https://sandbox.affirm.com/apps/prequal/?public_api_key=9KZ6U5QQCUY1L4MB&promo_external_id=promo_set_default_search&referring_url=http://affirm-demo.com/cherry/modal-close.html&unit_price=80000&page_type=product&use_promo=true";
    openModal(_url);
}

var third_party_cookies_enabled;

function thirdPartyCookies (cookieSentUrl) {
    if (!cookieSentUrl){return}
    fetchCookieSent(cookieSentUrl).then(
        function (response) {
            response.json().then(function(data) {
                if (data.cookie_sent) {
                    console.log('data.cookie_sent is true');
                    third_party_cookies_enabled = true;
                    return;
                }
                else {
                    third_party_cookies_enabled = false;
                    return;
                }
            });
        }
    ).catch(
        function (e) {
            return false;
        }
    );
}

function fetchCookieSent(cookieSentUrl) {
  return window.fetch(cookieSentUrl, {
    credentials: 'include',
    headers: {
      Accept: 'application/json'
    },
    method: 'GET'
  });
}

var popup;

function openModal(_url) {
    if (third_party_cookies_enabled) {
        popup = document.body.appendChild(newModal(_url));
    }
    else {
        popup = window.open(_url, "popup", 'width=600,height=400,scrollbars=yes');
    }
}

function closeModal() {
    var _modal = document.getElementById("affirm_checkout_modal")
    if (_modal) {
        _modal.parentNode.removeChild(_modal);
    }
    else {
        popup.close();
    }
}

function displayError(_main,_sub,_sub_extra) {
    var _container = document.createElement("div");
    _container.id = "error";
    var _template = `<h4>${_main}</h4>
<p id="sub">${_sub}</p>
<p id="sub_extra">${_sub_extra}</p>
<div id="error_close">Dismiss</div>`;
    _container.innerHTML = _template;
    document.body.appendChild(_container);
    document.getElementById("error_close").addEventListener("click",closeError);
}

function closeError() {
    var _error = document.getElementById("error");
    _error.parentNode.removeChild(_error);
}

function receiveMessage(event)
{
  // Do we trust the sender of this message?  (might be
  // different from what we originally opened, for example).
  // if (event.origin !== "http://localhost") {
  //   return;
  // }
  if (event.data.close_modal) {
    closeModal();
  }
  if (event.data.result === "confirm" && event.data.checkout_token.length > 0) {
    var _checkout_token = event.data.checkout_token;
    console.log("Fetching FD card details with this token: " + _checkout_token)
    var options = {
        action: "card",
        page: "affirm.php",
        params: "action=card&checkout_token=" + _checkout_token
    }
    ajaxRequest(options);
  }
  if (event.data.result === "cancel") {
    console.log("User cancelled.")
  }
  console.log(event);
}

function ajaxRequest(a) {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {

        if (a.action === "checkout") {
            if (xhttp.readyState === 4) {

                if (xhttp.status === 500) {
                    console.log(xhttp.status);
                }
                if (xhttp.status === 400) {
                    responseJson = JSON.parse(xhttp.responseText);
                    console.log(responseJson);
                    var _main = responseJson.ui.main;
                    var _sub = responseJson.ui.sub;
                    var _sub_extra = responseJson.ui.sub_extra;
                    displayError(_main,_sub,_sub_extra);
                }
                if (xhttp.status === 200) {
                    responseJson = JSON.parse(xhttp.responseText);
                    console.log(responseJson);
                    var _url = responseJson.redirect_url;
                    openModal(_url);
                }
                else {
                }   
            }
            else {
            }
        }
        if (a.action === "card") {
            if (xhttp.readyState === 4) {

                if (xhttp.status === 500) {
                    console.log(xhttp.status);
                }
                if (xhttp.status === 400) {
                    responseJson = JSON.parse(xhttp.responseText);
                    console.log(responseJson);
                    var _main = responseJson.ui.main;
                    var _sub = responseJson.ui.sub;
                    var _sub_extra = responseJson.ui.sub_extra;
                    displayError(_main,_sub,_sub_extra);
                }
                if (xhttp.status === 200) {
                    responseJson = JSON.parse(xhttp.responseText);
                    console.log(responseJson);
                    var _num = responseJson.number;
                    var _pin = responseJson.pin;
                    window.alert("Card number: " + _num + "\nPIN: " + _pin);
                }
                else {
                }   
            }
            else {
            }
        }
    };
    xhttp.open("POST", a.page, true);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhttp.send(a.params);
}
</script>
<body>
    <h1>Affirm Custom Modal + Server-side VCN Demo</h1>
<div id="container">
    <div id="form">
        <input type="text" id="name_first" placeholder="First name">
        <input type="text" id="name_last" placeholder="Last name">
        <input type="text" id="phone" placeholder="Phone number">
        <input type="text" id="email"  placeholder="Email address">
        <input type="text" id="address1"  placeholder="Address Line 1">
        <input type="text" id="address2"  placeholder="Address Line 2">
        <input type="text" id="city"  placeholder="City">
        <input type="text" id="state"  placeholder="State (2-character code)">
        <input type="text" id="zip"  placeholder="Zip">
    </div>
    <div class="btn" id="affirm_checkout">Affirm Checkout</div>
    <p>
    <div class="btn" class="affirm_learn_more" data-amount="50000" id="affirm_promo">Affirm Educational Modal</div>
    <p>
    <div id="affirm_ala">As low as $x a month with Affirm. <span data-amount="50000" class="affirm_learn_more">Learn more</span></div>
</div>
</body>
<script type="text/javascript">
// setup
window.addEventListener("message", function(e){receiveMessage(e)}, false);
document.getElementById("affirm_checkout").addEventListener("click",initiateCheckout, false);
var learn_more = document.getElementsByClassName("affirm_learn_more");
for (var i = learn_more.length - 1; i >= 0; i--) {
    learn_more[i].addEventListener("click",launchPromo, false);
}

parseQs();

thirdPartyCookies("https://cherry-ave-sandbox.affirm-odin.com/api/v2/cookie_sent");

setTimeout(function() {console.log(third_party_cookies_enabled);}, 500);

</script>
</html>